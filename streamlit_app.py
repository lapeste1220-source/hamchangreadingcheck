# -*- coding: utf-8 -*-
import os
import datetime
from pathlib import Path

import streamlit as st
from openai import OpenAI

# ---------------- ê¸°ë³¸ ì„¤ì • ----------------
st.set_page_config(
    page_title="í•¨ì°½ê³  ê¸€ íƒ€ë‹¹ì„± ê²€ì‚¬",
    layout="wide"
)

st.title("í•¨ì°½ê³  ë°•í˜¸ì¢… ì„ ìƒë‹˜ê³¼ í•¨ê»˜í•˜ëŠ” ê¸€ì˜ íƒ€ë‹¹ì„± ê²€ì‚¬")
st.caption("ê³ 2 ë¹„íŒì  ë…í•´ ìˆ˜ì—…ìš© Â· ìƒì„±í˜• AIë¥¼ í™œìš©í•œ ì£¼ì¥â€“ê·¼ê±° íƒ€ë‹¹ì„± ì ê²€ ë„êµ¬")

TODAY_STR = datetime.date.today().isoformat()

# ê°€ì„±ë¹„ ëª¨ë¸ ê°•ì œ
DEFAULT_MODEL = "gpt-4o-mini"

# êµì‚¬ìš© ë¹„ë°€ë²ˆí˜¸ (ì„ ìƒë‹˜ì´ ì½”ë“œì—ì„œ ì–¸ì œë“  ë³€ê²½ ê°€ëŠ¥)
ADMIN_PASSWORD = "hamchang123"

# ì„¸ì…˜ë‹¹ ìµœëŒ€ API í˜¸ì¶œ íšŸìˆ˜
MAX_CALLS = 2

# í•™ë²ˆ ì‚¬ìš© ê¸°ë¡ íŒŒì¼ (ì´ë¯¸ ì œì¶œí•œ í•™ë²ˆ ê´€ë¦¬ìš©)
USED_IDS_FILE = Path("used_ids.txt")


# ---------------- í•™ë²ˆ ê´€ë ¨ ìœ í‹¸ ----------------
CLASS_MAX = {1: 23, 2: 24, 3: 22, 4: 22}  # 2-1,2-2,2-3,2-4 ìµœëŒ€ ë²ˆí˜¸


def build_student_code(class_no: int, number: int) -> str:
    """
    2í•™ë…„ / ë°˜ / ë²ˆí˜¸ë¥¼ ë°›ì•„ì„œ '2111' í˜•ì‹ì˜ í•™ë²ˆ ì½”ë“œ ìƒì„±
    ì˜ˆ: 2í•™ë…„ 1ë°˜ 11ë²ˆ -> 2111
    """
    return f"2{class_no}{number:02d}"


def load_used_ids() -> set[str]:
    """ì´ë¯¸ ì œì¶œëœ í•™ë²ˆ ì½”ë“œ ì§‘í•©ì„ íŒŒì¼ì—ì„œ ì½ì–´ì˜¨ë‹¤."""
    if USED_IDS_FILE.exists():
        with USED_IDS_FILE.open("r", encoding="utf-8") as f:
            return {line.strip() for line in f if line.strip()}
    return set()


def save_used_id(student_code: str):
    """ìƒˆë¡œ ì œì¶œëœ í•™ë²ˆ ì½”ë“œë¥¼ íŒŒì¼ì— ì¶”ê°€í•œë‹¤."""
    with USED_IDS_FILE.open("a", encoding="utf-8") as f:
        f.write(student_code + "\n")


# ---------------- OpenAI ê´€ë ¨ í•¨ìˆ˜ ----------------
def get_api_key(user_input_key: str | None) -> str:
    """
    API í‚¤ ì„ íƒ ê·œì¹™
    1ìˆœìœ„: í•™ìƒì´ ì…ë ¥í•œ API í‚¤ (user_input_key)
    2ìˆœìœ„: êµì‚¬ìš© ë¹„ë°€ë²ˆí˜¸ë¥¼ ë§ì¶˜ ì„¸ì…˜ì¼ ë•Œ, ì„œë²„ì— ì €ì¥ëœ OPENAI_API_KEY
    ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ì—ëŸ¬ ë°œìƒ.
    """
    # 1) í•™ìƒ ê°œì¸ í‚¤ê°€ ìˆëŠ” ê²½ìš° â†’ ê·¸ í‚¤ ì‚¬ìš©
    if user_input_key and user_input_key.strip():
        return user_input_key.strip()

    # 2) í•™ìƒ í‚¤ëŠ” ì—†ì§€ë§Œ, êµì‚¬ìš© ë¹„ë°€ë²ˆí˜¸ë¥¼ ë§ì¶˜ ì„¸ì…˜ì¸ ê²½ìš° â†’ ì„ ìƒë‹˜ í‚¤ ì‚¬ìš©
    if st.session_state.get("is_admin", False):
        env_key = os.getenv("OPENAI_API_KEY")
        if not env_key:
            try:
                env_key = st.secrets.get("OPENAI_API_KEY", None)
            except Exception:
                env_key = None

        if env_key:
            return env_key
        else:
            raise ValueError(
                "êµì‚¬ìš© ë¹„ë°€ë²ˆí˜¸ëŠ” ë§ì•˜ì§€ë§Œ, ì„œë²„ì— OPENAI_API_KEY ì‹œí¬ë¦¿ì´ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
            )

    # 3) ë‘˜ ë‹¤ ì•„ë‹ˆë©´ â†’ ì‚¬ìš© ë¶ˆê°€
    raise ValueError(
        "OpenAI API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.\n"
        "- í•™ìƒ: ê°œì¸ OpenAI API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n"
        "- êµì‚¬: êµì‚¬ìš© ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ í•™êµ ê³µìš© í‚¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
    )


def call_openai_text(model: str, instructions: str, user_input: str, api_key: str) -> str:
    """
    OpenAI Chat Completions APIë¥¼ ì‚¬ìš©í•´ í…ìŠ¤íŠ¸ë¥¼ ë°˜í™˜.
    """
    client = OpenAI(api_key=api_key)

    try:
        resp = client.chat.completions.create(
            model=model,
            messages=[
                {"role": "system", "content": instructions},
                {"role": "user", "content": user_input},
            ],
        )
    except Exception as e:
        raise RuntimeError(f"OpenAI í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")

    try:
        return resp.choices[0].message.content.strip()
    except Exception:
        return str(resp)


def can_call_api() -> bool:
    """ë‚¨ì€ í˜¸ì¶œ ê°€ëŠ¥ íšŸìˆ˜ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³ , ì—†ìœ¼ë©´ ê²½ê³ ë¥¼ ë„ìš´ë‹¤."""
    used = st.session_state.get("usage_count", 0)
    if used >= MAX_CALLS:
        st.warning(f"ì´ ì„¸ì…˜ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ìµœëŒ€ í˜¸ì¶œ íšŸìˆ˜({MAX_CALLS}íšŒ)ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.")
        return False
    return True


def increase_api_count():
    """API í˜¸ì¶œ íšŸìˆ˜ 1íšŒ ì¦ê°€."""
    st.session_state["usage_count"] = st.session_state.get("usage_count", 0) + 1


# ---------------- íƒ€ë‹¹ì„± í‰ê°€ìš© ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ----------------
ANALYSIS_INSTRUCTIONS = f"""
ë‹¹ì‹ ì€ ê³ ë“±í•™êµ 2í•™ë…„ í•™ìƒì„ ë•ëŠ” 'ë¹„íŒì  ë…í•´Â·íƒ€ë‹¹ì„± í‰ê°€ ë„ìš°ë¯¸'ì…ë‹ˆë‹¤.
ì•„ë˜ ê·œì¹™ê³¼ ì¶œë ¥ í˜•ì‹ì„ ë°˜ë“œì‹œ ë”°ë¥´ì‹­ì‹œì˜¤.

# ëª©í‘œ
- í•™ìƒì´ ì œì‹œí•œ 'ì…ë ¥ ì§€ë¬¸'ì„ ëŒ€ìƒìœ¼ë¡œ
  1) **íƒ€ë‹¹ì„± ê²€ì‚¬ê°€ í•„ìš”í•œ ì£¼ì¥/ë¶€ë¶„**ì„ ì°¾ì•„ë‚´ê³ ,
  2) ê° ë¶€ë¶„ì— ëŒ€í•œ **ê²€ì‚¬Â·ê²€ì¦ ê²°ê³¼**ë¥¼ ì •ë¦¬í•˜ë©°,
  3) **íƒ€ë‹¹ì„± í‰ê°€(5ì  ì²™ë„)**ë¥¼ ì œì‹œí•˜ë„ë¡ ë•ìŠµë‹ˆë‹¤.

# ë§¥ë½ Â· ì œì•½
- ë°°ê²½: ê³ 2 ë¹„íŒì  ë…í•´ ìˆ˜ì—….
- ì €ì‘ê¶Œ ì¤€ìˆ˜(ì§ì ‘ ì¸ìš©ì€ 40~80ìÂ·í•„ìš” ìµœì†Œ).
- ì‹¤ì œ ì›¹ ê²€ìƒ‰ì€ í•˜ì§€ ë§ê³ , ê¸°ì–µì— ê¸°ë°˜í•´ ëŒ€í‘œì ì¸ ê¸°ê´€Â·êµì¬Â·ë…¼ë¬¸Â·ë„ì„œë¥¼ ì˜ˆë¡œ ë“œì„¸ìš”.
- URLì´ í•„ìš”í•  ë•ŒëŠ” ì‹¤ì œë¡œ ìˆì„ ë²•í•œ í˜•ì‹ì„ ì“°ë˜, í™•ì‹¤í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ê´€ëª…Â·ìë£Œëª…Â·ì—°ë„Â·ê²€ìƒ‰ì–´ë§Œ ì œì‹œí•˜ê³ 
  ì„ì˜ì˜ ì£¼ì†Œë¥¼ ë§Œë“¤ì–´ë‚´ì§€ ë§ˆì‹­ì‹œì˜¤.

# íƒ€ë‹¹ë„ 5ì  ì²™ë„
- 5ì : íƒ€ë‹¹ë„ê°€ ì•„ì£¼ ë†’ìŒ (ê·¼ê±°ê°€ ì¶©ë¶„Â·ì •í™•, ì‹ ë¢°ë„ ë†’ì€ ì¶œì²˜, ë°˜ë¡€ ê°€ëŠ¥ì„± ë‚®ìŒ)
- 4ì : íƒ€ë‹¹ë„ê°€ ë†’ìœ¼ë‚˜ ëª…í™•í•œ ì¶œì²˜ í™•ì¸ í•„ìš”
- 3ì : íƒ€ë‹¹ë„ê°€ ìˆìœ¼ë‚˜ ì¶œì²˜ê°€ ì—†ìŒ ë˜ëŠ” ì•½í•¨
- 2ì : íŠ¹ìˆ˜ ì‚¬ë¡€ì´ê±°ë‚˜ ì¼ë°˜í™”ê°€ ì–´ë ¤ìš´ ê·¼ê±°ì— ì˜ì¡´
- 1ì : ê·¼ê±°ê°€ ì—†ê±°ë‚˜ ì£¼ì¥ê³¼ ì§ì ‘ ì—°ê²°ë˜ì§€ ì•ŠìŒ

# Plan First (ê°„ë‹¨ ê³„íš 5ì¤„)
1) ì§€ë¬¸ ì£¼ì œÂ·í•µì‹¬ ì£¼ì¥ í›„ë³´
2) íƒ€ë‹¹ì„± ê²€ì‚¬ê°€ íŠ¹íˆ í•„ìš”í•œ ë¶€ë¶„(ê°œë…Â·ì „ì œÂ·ì˜ˆì‹œ ë“±)
3) ê·¼ê±°ì˜ ì¢…ë¥˜(ë°ì´í„°/ì „ë¬¸ê°€ ê²¬í•´/ë…¼ë¦¬/ì‚¬ë¡€/ê¶Œìœ„ ì¸ìš© ë“±) ë¶„í¬ ì˜ˆìƒ
4) ì™¸ë¶€ ê²€ì¦ì´ í•„ìš”í•œ ìŸì  í›„ë³´
5) ì‚¬ìš©í•  ë„ì‹í™” ë°©ì‹(í…ìŠ¤íŠ¸ íŠ¸ë¦¬ì™€ í‘œ)ì™€ ì´ìœ 

# ë‹¨ê³„ë³„ ì§€ì¹¨
1) ì§€ë¬¸ì„ 3ë¬¸ì¥ ì´ë‚´ë¡œ ìš”ì•½í•˜ê³ , í•µì‹¬ ì£¼ì¥ 3ê°œ ì´ë‚´ë¡œ ë²ˆí˜¸ ë§¤ê²¨ ì œì‹œ.
2) ê° ì£¼ì¥ì— ëŒ€í•´ **íƒ€ë‹¹ì„± ê²€ì‚¬ê°€ í•„ìš”í•œ ë¶€ë¶„**ì„ ì°¾ê³ , ì§§ê²Œ ì¸ìš©(40~80ì) + ì´ìœ  ì„¤ëª….
3) ì£¼ì¥ë³„ë¡œ **ê²€ì‚¬Â·ê²€ì¦ ê²°ê³¼**ë¥¼ ì •ë¦¬:
   - ì‚¬ì‹¤ ì—¬ë¶€, ê°œë… ì‚¬ìš© ì ì ˆì„±, ì „ì œì˜ ëª…ì‹œ ì—¬ë¶€ ë“±.
4) ê° ì£¼ì¥ì— ëŒ€í•´ **íƒ€ë‹¹ì„± í‰ê°€(5ì  ì²™ë„)** ì ìˆ˜ì™€ ì´ìœ (1~2ë¬¸ì¥)ë¥¼ ì œì‹œ.
5) í•„ìš”í•˜ë©´ ì™¸ë¶€ ê²€ì¦ì— ì‚¬ìš©í•  ë§Œí•œ ê¸°ê´€/ìë£Œ/ë„ì„œ/ë…¼ë¬¸ ì˜ˆì‹œë¥¼ 1~3ê°œ ì •ë„ ì œì•ˆ.

# ì¶œë ¥ í˜•ì‹(ë§ˆí¬ë‹¤ìš´, ì´ êµ¬ì¡°ë¥¼ ìœ ì§€)
## 1) í•œëˆˆì— ë³´ëŠ” ìš”ì•½
- ì§€ë¬¸ ì£¼ì œ/í•µì‹¬ ì£¼ì¥(ìµœëŒ€ 3ê°œ)
- ì „ì²´ì ìœ¼ë¡œ íƒ€ë‹¹ì„±ì´ ì·¨ì•½í•œ í•µì‹¬ í¬ì¸íŠ¸ 2~3ê°œ

## 2) íƒ€ë‹¹ì„± ê²€ì‚¬ê°€ í•„ìš”í•œ ë¶€ë¶„
- ì£¼ì¥ A: (ìš”ì•½)
  - ì¸ìš©: "..." (ëŒ€ëµì ì¸ ìœ„ì¹˜)
  - ì™œ ì´ ë¶€ë¶„ì´ íŠ¹íˆ ì ê²€ì´ í•„ìš”í•œì§€
- ì£¼ì¥ B: ...

## 3) ê²€ì‚¬Â·ê²€ì¦ ê²°ê³¼ ì •ë¦¬
- ì£¼ì¥ A
  - ì‚¬ì‹¤ì„±/ê°œë… ì‚¬ìš©/ì „ì œ ëª…ì‹œ ì—¬ë¶€ ë“±
- ì£¼ì¥ B
  - ...

## 4) íƒ€ë‹¹ì„± í‰ê°€(5ì  ì²™ë„)

| ì£¼ì¥ | í•µì‹¬ ë‚´ìš© ìš”ì•½ | íƒ€ë‹¹ë„(1~5ì ) | ì±„ì  ì´ìœ (1~2ë¬¸ì¥) |
|---|---|---|---|

## 5) ê²€ì¦ìš© ë§í¬Â·ì¶œì²˜ ì œì•ˆ
- (ì›¹ì‚¬ì´íŠ¸) ì˜ˆ: í•œêµ­ì€í–‰ ê²½ì œêµìœ¡ / í†µê³„ì²­ KOSIS / KDI ë¦¬í¬íŠ¸ / ëŒ€í•™ ê°•ì˜ë…¸íŠ¸ ë“±
- (ë„ì„œ) ì˜ˆ: í‘œì¤€ ê²½ì œí•™ êµê³¼ì„œÂ·ì…ë¬¸ì„œ
- (ë…¼ë¬¸/í•™ìˆ ìë£Œ) ì˜ˆ: ê²½ì œí•™ í•™ìˆ ë…¼ë¬¸Â·ì •ì±… ë³´ê³ ì„œ ë“±
â€» ì‹¤ì œ ì£¼ì†Œë¥¼ ëª¨ë¥¼ ê²½ìš°, ê¸°ê´€ëª…Â·ìë£Œëª…Â·ì—°ë„Â·ì¶”ì²œ ê²€ìƒ‰ì–´ë§Œ ì œì‹œ.

## 6) í•™ìƒ ì„ íƒìš© ì£¼ì¥ ëª©ë¡
ì•„ë˜ í˜•ì‹ì„ ì§€í‚¤ì„¸ìš”. ë‚˜ì¤‘ì— í•™ìƒì´ ì„ íƒí•´ ìµœì¢… ê¸€ì— ë°˜ì˜í•  ì£¼ì¥ ëª©ë¡ì…ë‹ˆë‹¤.

- [ì„ íƒ1] ì£¼ì¥ A: (í•œ ì¤„ ìš”ì•½)
- [ì„ íƒ2] ì£¼ì¥ B: (í•œ ì¤„ ìš”ì•½)
- [ì„ íƒ3] ì£¼ì¥ C: (í•œ ì¤„ ìš”ì•½)

## 7) Self-Check
- íƒ€ë‹¹ì„± ê²€ì‚¬ê°€ í•„ìš”í•œ ë¶€ë¶„ì´ ë¹ ì§ì—†ì´ ì •ë¦¬ë˜ì—ˆëŠ”ê°€?
- ê²€ì‚¬Â·ê²€ì¦ ê²°ê³¼ê°€ ê·¼ê±°ë¥¼ ê°€ì§€ê³  ì„œìˆ ë˜ì—ˆëŠ”ê°€?
- 5ì  ì²™ë„ ê¸°ì¤€ì´ ì¼ê´€ë˜ê²Œ ì ìš©ë˜ì—ˆëŠ”ê°€?

# í†¤
- ê³ 2 í•™ìƒì´ ì½ì„ ìˆ˜ ìˆë„ë¡, ì–´ë ¤ìš´ ìš©ì–´ëŠ” ì§§ê²Œ í’€ì´ë¥¼ ë§ë¶™ì´ì„¸ìš”.
"""


# ---------------- ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” ----------------
if "analysis_result" not in st.session_state:
    st.session_state["analysis_result"] = ""

if "final_report" not in st.session_state:
    st.session_state["final_report"] = ""

if "usage_count" not in st.session_state:
    st.session_state["usage_count"] = 0

if "is_admin" not in st.session_state:
    st.session_state["is_admin"] = False

if "selected_for_report" not in st.session_state:
    st.session_state["selected_for_report"] = ""

if "used_ids" not in st.session_state:
    st.session_state["used_ids"] = load_used_ids()

if "include_needs_check" not in st.session_state:
    st.session_state["include_needs_check"] = True
if "include_verification" not in st.session_state:
    st.session_state["include_verification"] = True
if "include_scores" not in st.session_state:
    st.session_state["include_scores"] = True


# ---------------- ì‚¬ì´ë“œë°”: ì‚¬ìš© ì•ˆë‚´ + êµì‚¬ìš© ì„¤ì • ----------------
with st.sidebar:
    st.header("ì‚¬ìš© ì•ˆë‚´")
    st.markdown(
        """
**ì‚¬ìš© ìˆœì„œ**

1. 2í•™ë…„ ë°˜Â·ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ë©´ í•™ë²ˆ ì½”ë“œê°€ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.
2. ì´ë¦„, ì„ ì • ë™ê¸°, ì§€ë¬¸ì„ ì…ë ¥í•©ë‹ˆë‹¤.
3. ì¼ë°˜ì ì¸ íƒ€ë‹¹ì„± ê²€ì‚¬ í¬ì¸íŠ¸ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.
4. (ì„ íƒ) ê°œì¸ OpenAI API í‚¤ ë˜ëŠ” êµì‚¬ìš© ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.
5. **[3. 1ë‹¨ê³„: ìƒì„±í˜• AIë¥¼ í™œìš©í•œ íƒ€ë‹¹ì„± ë¶„ì„]** ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
6. ë¶„ì„ ê²°ê³¼ ì¤‘ì—ì„œ ì™„ì„± ê¸€ì— ë°˜ì˜í•  í•­ëª©ì„ ì²´í¬ë°•ìŠ¤ë¡œ ì„ íƒí•©ë‹ˆë‹¤.
7. í™œë™ ê²°ê³¼Â·ëŠë‚€ ì ì„ ì ê³ , **[2ë‹¨ê³„: ì™„ì„±ëœ ê¸€ ìƒì„±]** ë²„íŠ¼ì„ ëˆ„ë¦…ë‹ˆë‹¤.
8. ì™„ì„±ëœ ê¸€ì„ ë‹¤ìš´ë¡œë“œ(.txt)í•˜ì—¬ ì œì¶œí•©ë‹ˆë‹¤.
        """
    )

    st.markdown("---")
    st.markdown("**í˜„ì¬ ì„¸ì…˜ ì‚¬ìš©ëŸ‰**")
    st.write(f"API í˜¸ì¶œ ì‚¬ìš© íšŸìˆ˜: {st.session_state['usage_count']} / {MAX_CALLS}")

    st.markdown("---")
    st.subheader("êµì‚¬ìš© ì„¤ì •")

    admin_pw = st.text_input(
        "êµì‚¬ìš© ë¹„ë°€ë²ˆí˜¸ (ì…ë ¥ ì‹œ í•™êµ ê³µìš© í‚¤ ì‚¬ìš© ê°€ëŠ¥)",
        type="password"
    )

    if admin_pw == ADMIN_PASSWORD:
        st.session_state["is_admin"] = True
        st.caption("âœ… êµì‚¬ìš© ë¹„ë°€ë²ˆí˜¸ê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ì„¸ì…˜ì—ì„œëŠ” í•™êµ ê³µìš© API í‚¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
    elif admin_pw:
        st.session_state["is_admin"] = False
        st.caption("âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (í•™ìƒì€ ê°œì¸ API í‚¤ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.)")

    st.markdown("---")
    st.markdown("**API í‚¤ ì•ˆë‚´**")
    st.caption(
        "í•™ìƒ: ê°œì¸ OpenAI API í‚¤ê°€ ìˆìœ¼ë©´ ì…ë ¥ë€ì— ë„£ì–´ ì‚¬ìš©í•˜ì„¸ìš”.\n"
        "êµì‚¬: êµì‚¬ìš© ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë©´ ì„œë²„ì— ì €ì¥ëœ í•™êµ ê³µìš© í‚¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
    )


# ---------------- ë©”ì¸ ì…ë ¥ ì˜ì—­ ----------------
col_left, col_right = st.columns([2, 1])

with col_left:
    st.subheader("1. ê¸°ë³¸ ì •ë³´ ë° í•™ìƒ ì…ë ¥ ì˜ì—­")

    class_no = st.selectbox("ë°˜ì„ ì„ íƒí•˜ì„¸ìš”. (2í•™ë…„)", options=[1, 2, 3, 4], format_func=lambda x: f"2í•™ë…„ {x}ë°˜")
    max_number = CLASS_MAX[class_no]
    number = st.selectbox("ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.", options=list(range(1, max_number + 1)))
    student_code = build_student_code(class_no, number)

    st.markdown(f"**ìë™ ìƒì„± í•™ë²ˆ ì½”ë“œ:** `{student_code}`")

    student_name = st.text_input("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.", placeholder="ì˜ˆ) í™ê¸¸ë™")

    selected_motivation = st.text_area(
        "â‘  ì´ ê¸€(ë˜ëŠ” ì±…/ìë£Œ)ì„ ì„ íƒí•œ ì´ìœ (ì„ ì • ë™ê¸°)ë¥¼ ì ì–´ ë³´ì„¸ìš”.",
        height=80,
        placeholder="ì˜ˆ) ê²½ì œì—ì„œ 'í•©ë¦¬ì  ì„ íƒ'ì´ ì‹¤ì œ ê¸°ì—… í–‰ë™ê³¼ ì—°ê²°ë˜ëŠ” ë°©ì‹ì´ ê¶ê¸ˆí•´ì„œ ì„ íƒí–ˆë‹¤."
    )

    passage_text = st.text_area(
        "â‘¡ íƒ€ë‹¹ì„±ì„ í‰ê°€í•˜ê³  ì‹¶ì€ ê¸€(ì§€ë¬¸)ì„ ë¶™ì—¬ ë„£ìœ¼ì„¸ìš”.",
        value="",
        height=260,
        placeholder="ë¶„ì„í•˜ê³  ì‹¶ì€ ê¸€(ì§€ë¬¸)ì„ ì—¬ê¸°ì— ë¶™ì—¬ ë„£ìœ¼ì„¸ìš”."
    )

    st.markdown("**â‘¢ ì¼ë°˜ì ì¸ íƒ€ë‹¹ì„± ê²€ì‚¬ í¬ì¸íŠ¸ (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)**")

    validity_options = [
        "ì£¼ì¥ì— ë§ëŠ” ê·¼ê±°ê°€ ì œì‹œë˜ì–´ ìˆëŠ”ê°€?",
        "ê·¼ê±°ì˜ ì–‘ì´ ì¶©ë¶„í•œê°€?",
        "ê·¼ê±°ì˜ ì§ˆì´ ì¶©ë¶„í•œê°€?",
        "ê·¼ê±°ì˜ ì¶œì²˜ê°€ ëª…í™•í•œê°€?",
        "ê·¼ê±°ì˜ ì¶œì²˜ê°€ ì œì‹œëœ ì´í›„ ë°˜ë¡ ì´ë‚˜ ë°˜ë°• ì‚¬ë¡€ê°€ ì—†ëŠ”ê°€?",
        "í•´ë‹¹ ê·¼ê±°ê°€ ì‚¬ì‹¤ìƒ ìœ ì¼í•œ ê·¼ê±°ë¡œì„œì˜ í˜ì´ ìˆëŠ”ê°€?",
        "ê¸°íƒ€(í•™ìƒì´ ë”°ë¡œ ì ì„ ë¶€ë¶„)"
    ]
    selected_points = st.multiselect(
        "íƒ€ë‹¹ì„± ì¡°ì‚¬ í¬ì¸íŠ¸ ì„ íƒ",
        options=validity_options,
        default=[
            "ì£¼ì¥ì— ë§ëŠ” ê·¼ê±°ê°€ ì œì‹œë˜ì–´ ìˆëŠ”ê°€?",
            "ê·¼ê±°ì˜ ì¶œì²˜ê°€ ëª…í™•í•œê°€?",
        ]
    )

    extra_point = st.text_input(
        "â‘£ ìœ„ì— ì—†ëŠ” ë‹¤ë¥¸ ì¡°ì‚¬ í¬ì¸íŠ¸ê°€ ìˆë‹¤ë©´ ì ì–´ ì£¼ì„¸ìš” (ì„ íƒ).",
        placeholder="ì˜ˆ) êµê³¼ì„œì—ì„œ ë°°ìš´ ë‚´ìš©ê³¼ ë‹¤ë¥¸ ë¶€ë¶„ì´ ìˆëŠ”ì§€ ë“±"
    )

with col_right:
    st.subheader("2. OpenAI API ì„¤ì •")
    user_api_key_input = st.text_input(
        "OpenAI API í‚¤ (ì„ íƒ, ì—†ìœ¼ë©´ êµì‚¬ìš© ë¹„ë°€ë²ˆí˜¸ë¡œ ê³µìš© í‚¤ ì‚¬ìš©)",
        type="password",
        help="í•™ìƒ: ê°œì¸ í‚¤ ì…ë ¥ / êµì‚¬: ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í›„ ê³µìš© í‚¤ ì‚¬ìš©"
    )

    st.markdown("---")
    st.subheader("4. í™œë™ ê²°ê³¼ ë©”ëª¨ (2ë‹¨ê³„ì—ì„œ í™œìš©)")
    activity_notes = st.text_area(
        "íƒ€ë‹¹ì„± ë¶„ì„ ê²°ê³¼ë¥¼ ì½ê³ , ìŠ¤ìŠ¤ë¡œ ì •ë¦¬í•œ í™œë™ ê²°ê³¼Â·ëŠë‚€ ì ì„ ê°„ë‹¨íˆ ì ì–´ ë³´ì„¸ìš”.",
        height=160,
        placeholder="ì˜ˆ) A ì£¼ì¥ì— ë¹„í•´ B ì£¼ì¥ì€ ê·¼ê±°ê°€ ì•½í•˜ë‹¤ëŠ” ëŠë‚Œì„ ë°›ì•˜ê³ , ì•ìœ¼ë¡œ ê²½ì œ ê¸°ì‚¬ë¥¼ ì½ì„ ë•Œë„ ê·¼ê±°ì˜ ì¶œì²˜ë¥¼ ë” ê¼¼ê¼¼íˆ ë³´ì•„ì•¼ê² ë‹¤ê³  ìƒê°í–ˆë‹¤."
    )


# ---------------- 1ë‹¨ê³„: íƒ€ë‹¹ì„± ë¶„ì„ ì‹¤í–‰ ----------------
st.markdown("---")
st.subheader("3. 1ë‹¨ê³„: ìƒì„±í˜• AIë¥¼ í™œìš©í•œ íƒ€ë‹¹ì„± ë¶„ì„")

if st.button("ğŸ§ª 1ë‹¨ê³„: íƒ€ë‹¹ì„± ë¶„ì„ ì‹¤í–‰", type="primary"):
    if not passage_text.strip():
        st.error("ì§€ë¬¸(ë¶„ì„í•  ê¸€)ì„ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”.")
    else:
        if not can_call_api():
            st.stop()

        try:
            api_key = get_api_key(user_api_key_input)
        except ValueError as e:
            st.error(str(e))
        else:
            with st.spinner("íƒ€ë‹¹ì„± ë¶„ì„ì„ ìˆ˜í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”..."):
                points_text = ", ".join(selected_points) if selected_points else "í•™ìƒì´ ë³„ë„ í¬ì¸íŠ¸ë¥¼ ì„ íƒí•˜ì§€ ì•ŠìŒ"
                if extra_point.strip():
                    points_text += f"; ì¶”ê°€ í¬ì¸íŠ¸: {extra_point.strip()}"

                user_input_for_analysis = f"""
[í•™ìƒ ê¸°ë³¸ ì •ë³´]
í•™ë²ˆ ì½”ë“œ: {student_code}
ì´ë¦„: {student_name}
ë°˜: 2í•™ë…„ {class_no}ë°˜, ë²ˆí˜¸: {number}

[í•™ìƒ ì„ ì • ë™ê¸°]
{selected_motivation}

[í•™ìƒì´ íŠ¹íˆ ì ê²€í•˜ê³  ì‹¶ì€ íƒ€ë‹¹ì„± í¬ì¸íŠ¸]
{points_text}

[ë¶„ì„ ëŒ€ìƒ ì§€ë¬¸]
{passage_text}
"""

                try:
                    analysis_result = call_openai_text(
                        model=DEFAULT_MODEL,
                        instructions=ANALYSIS_INSTRUCTIONS,
                        user_input=user_input_for_analysis,
                        api_key=api_key,
                    )
                    st.session_state["analysis_result"] = analysis_result
                    increase_api_count()
                except RuntimeError as e:
                    st.error(str(e))


# ---------------- ë¶„ì„ ê²°ê³¼ í‘œì‹œ + ì²´í¬ë°•ìŠ¤(ì–´ë–¤ ë‚´ìš©ì„ ìµœì¢… ê¸€ì— ë°˜ì˜í• ì§€) ----------------
if st.session_state["analysis_result"]:
    st.success("1ë‹¨ê³„ íƒ€ë‹¹ì„± ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
    st.markdown("### ğŸ” AI ê¸°ë°˜ íƒ€ë‹¹ì„± ë¶„ì„ ê²°ê³¼")
    st.markdown(st.session_state["analysis_result"])

    st.markdown("---")
    st.subheader("5. ì™„ì„±ëœ ê¸€ì— ì–´ë–¤ ë‚´ìš©ì„ ë°˜ì˜í• ê¹Œìš”? (ì²´í¬ë°•ìŠ¤ ì„ íƒ)")

    col_c1, col_c2, col_c3 = st.columns(3)
    with col_c1:
        include_needs_check = st.checkbox(
            "íƒ€ë‹¹ì„± ê²€ì‚¬ê°€ í•„ìš”í•œ ë¶€ë¶„",
            value=st.session_state["include_needs_check"]
        )
    with col_c2:
        include_verification = st.checkbox(
            "ê²€ì‚¬Â·ê²€ì¦ ê²°ê³¼ ì •ë¦¬",
            value=st.session_state["include_verification"]
        )
    with col_c3:
        include_scores = st.checkbox(
            "íƒ€ë‹¹ì„± í‰ê°€(ì ìˆ˜)",
            value=st.session_state["include_scores"]
        )

    st.session_state["include_needs_check"] = include_needs_check
    st.session_state["include_verification"] = include_verification
    st.session_state["include_scores"] = include_scores

    st.markdown(
        """
ìœ„ì—ì„œ ì²´í¬í•œ í•­ëª©ë“¤ë§Œ **ì™„ì„±ëœ ê¸€(ë³´ê³ ì„œ)** ì•ˆì—ì„œ ìì„¸íˆ ë‹¤ë¤„ì§‘ë‹ˆë‹¤.
(ì²´í¬ í•´ì œëœ ì˜ì—­ì€ ê°„ë‹¨íˆ ì–¸ê¸‰ë˜ê±°ë‚˜ ìƒëµë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)
        """
    )

    st.markdown("#### ğŸ¯ ìµœì¢… ê¸€ì— ë°˜ì˜í•˜ê³  ì‹¶ì€ ì£¼ì¥Â·ë…¼ì  ì •ë¦¬")
    selected_for_report = st.text_area(
        "íƒ€ë‹¹ì„± ë¶„ì„ ê²°ê³¼ë¥¼ ì½ê³ , **ì™„ì„±ëœ ê¸€ì— ê¼­ ë°˜ì˜í•˜ê³  ì‹¶ì€ ì£¼ì¥Â·ë…¼ì ë§Œ** bullet í˜•ì‹ìœ¼ë¡œ ì •ë¦¬í•´ ë³´ì„¸ìš”.\n"
        "â€» ì—¬ê¸° ì ì€ ë‚´ìš©ì´ ìµœì¢… ë³´ê³ ì„œì˜ ì¤‘ì‹¬ì´ ë©ë‹ˆë‹¤.",
        height=180,
        placeholder="ì˜ˆ)\n- í•œê³„ë¹„ìš©ê³¼ í•œê³„ìˆ˜ì…ì´ ì¼ì¹˜í•  ë•Œ ì´ìœ¤ì´ ê·¹ëŒ€í™”ëœë‹¤ëŠ” ì£¼ì¥ì€ ê·¼ê±°ê°€ ë¹„êµì  íƒ„íƒ„í–ˆë‹¤.\n- í‰ê· ë¹„ìš©ê³¼ ì†ì‹¤ íŒë‹¨ ë¶€ë¶„ì€ ë‹¨ê¸°/ì¥ê¸° êµ¬ë¶„ì´ ë¶ˆë¶„ëª…í•´ ì¶”ê°€ ê²€ì¦ì´ í•„ìš”í•˜ë‹¤.",
        value=st.session_state.get("selected_for_report", "")
    )
    st.session_state["selected_for_report"] = selected_for_report

else:
    st.info("ì•„ì§ 1ë‹¨ê³„ ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ ë²„íŠ¼ìœ¼ë¡œ ë¨¼ì € íƒ€ë‹¹ì„± ë¶„ì„ì„ ì‹¤í–‰í•´ ì£¼ì„¸ìš”.")


# ---------------- 2ë‹¨ê³„: ì™„ì„±ëœ ê¸€(ë³´ê³ ì„œ) ìƒì„± ----------------
st.markdown("---")
st.subheader("6. 2ë‹¨ê³„: í•™ìƒ í™œë™ê¹Œì§€ ë°˜ì˜í•œ ì™„ì„± ê¸€ ìƒì„±")

FINAL_REPORT_INSTRUCTIONS = f"""
ë‹¹ì‹ ì€ 'ë¹„íŒì  ë…í•´ í™œë™ ë³´ê³ ì„œ'ë¥¼ ì‘ì„±í•˜ëŠ” ì¡°êµì…ë‹ˆë‹¤.
ì•„ë˜ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ê³ ë“±í•™êµ 2í•™ë…„ í•™ìƒì˜ í™œë™ ê²°ê³¼ë¥¼ ì •ë¦¬í•œ ê¸€ì„ ì¨ ì£¼ì„¸ìš”.

# ë§¤ìš° ì¤‘ìš”í•œ ì œí•œ
- ì „ì²´ ë¶„ëŸ‰ì€ **í•œêµ­ì–´ ê¸°ì¤€ ê³µë°± í¬í•¨ ì•½ 1,800~2,200ì(2000ì ë‚´ì™¸)**ë¡œ í•˜ì‹­ì‹œì˜¤.
- 2,200ìë¥¼ ë„˜ê¸°ì§€ ë§ˆì‹­ì‹œì˜¤.
- ì•„ë˜ ì •ë³´ ì¤‘,
  - [í•™ìƒì´ ìµœì¢… ê¸€ì— ë°˜ì˜í•˜ê³ ì ì„ íƒí•œ ì£¼ì¥/ë…¼ì ],
  - ê·¸ë¦¬ê³  ì²´í¬ë°•ìŠ¤ë¡œ ì„ íƒëœ ì˜ì—­:
    - íƒ€ë‹¹ì„± ê²€ì‚¬ê°€ í•„ìš”í•œ ë¶€ë¶„ í¬í•¨ ì—¬ë¶€
    - ê²€ì‚¬Â·ê²€ì¦ ê²°ê³¼ í¬í•¨ ì—¬ë¶€
    - íƒ€ë‹¹ì„± í‰ê°€(ì ìˆ˜) í¬í•¨ ì—¬ë¶€
  ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ê¸€ì„ êµ¬ì„±í•©ë‹ˆë‹¤.

# êµ¬ì„± ì œì•ˆ
1) í™œë™ ë°°ê²½Â·ì„ ì • ë™ê¸° (1~2ë¬¸ë‹¨)
2) ì§€ë¬¸ í•µì‹¬ ë‚´ìš©ê³¼ í•™ìƒì´ ì„ íƒí•œ ì£¼ìš” ì£¼ì¥ ì •ë¦¬ (1ë¬¸ë‹¨)
3) **í•™ìƒì´ ì„ íƒí•œ ì£¼ì¥/ë…¼ì ì— ëŒ€í•œ íƒ€ë‹¹ì„± ë¶„ì„ ê³¼ì • ìš”ì•½**
   - (ì²´í¬ëœ í•­ëª©ì— ë”°ë¼)
     - íƒ€ë‹¹ì„± ê²€ì‚¬ê°€ í•„ìš”í•œ ë¶€ë¶„ ì„¤ëª…
     - ê²€ì‚¬Â·ê²€ì¦ ê²°ê³¼ ìš”ì•½
     - íƒ€ë‹¹ì„± í‰ê°€(ì ìˆ˜)ì— ëŒ€í•œ í•™ìƒì˜ ì´í•´ì™€ ëŠë‚€ ì 
4) ì™¸ë¶€ ê²€ì¦(ì¶œì²˜Â·ìë£Œ ì¡°ì‚¬) ê³„íš ë˜ëŠ” ì˜ˆì‹œ 1~2ê°œ
5) í™œë™ì„ í†µí•´ ë°°ìš´ ì Â·ì•ìœ¼ë¡œì˜ ë‹¤ì§ (1~2ë¬¸ë‹¨)

# ì²´í¬ë°•ìŠ¤ì— ë”°ë¥¸ í¬í•¨ ê·œì¹™
- include_needs_check == True ì¸ ê²½ìš°:
  - 'íƒ€ë‹¹ì„± ê²€ì‚¬ê°€ í•„ìš”í•œ ë¶€ë¶„'ì„ ë³¸ë¬¸ì—ì„œ êµ¬ì²´ì ì¸ ì˜ˆì‹œì™€ í•¨ê»˜ ë‹¤ë£¨ì‹­ì‹œì˜¤.
- include_verification == True ì¸ ê²½ìš°:
  - 'ê²€ì‚¬Â·ê²€ì¦ ê²°ê³¼(ì‚¬ì‹¤ì„±Â·ê°œë… ì‚¬ìš©Â·ì „ì œ ë“±)'ë¥¼ ë³¸ë¬¸ì—ì„œ ì •ë¦¬í•´ ì£¼ì„¸ìš”.
- include_scores == True ì¸ ê²½ìš°:
  - 'íƒ€ë‹¹ì„± í‰ê°€(5ì  ì²™ë„)'ë¥¼ ì–¸ê¸‰í•˜ë˜, ìˆ«ì ìì²´ë³´ë‹¤ í•™ìƒì´ ì ìˆ˜ë¥¼ ì–´ë–»ê²Œ í•´ì„í–ˆëŠ”ì§€ ì¤‘ì‹¬ìœ¼ë¡œ ì„œìˆ í•˜ì‹­ì‹œì˜¤.
- Falseì¸ í•­ëª©ì€ ë³¸ë¬¸ì—ì„œ ìƒëµí•˜ê±°ë‚˜ ê°„ë‹¨í•œ í•œë‘ ë¬¸ì¥ ì–¸ê¸‰ì— ê·¸ì¹˜ì‹­ì‹œì˜¤.

# í†¤
- ë˜ë ·í•˜ê³  ì§„ì§€í•˜ì§€ë§Œ, ê³ 2 í•™ìƒì˜ ìì—°ìŠ¤ëŸ¬ìš´ ê¸€ ëŠë‚Œ ìœ ì§€
- ê³¼ì¥ëœ í‘œí˜„ë³´ë‹¤ ì‹¤ì œ ìˆ˜ì—… í™œë™ì— ê°€ê¹Œìš´ ëŠë‚Œìœ¼ë¡œ ì‘ì„±

# ê¸¸ì´
- A4 ê¸°ì¤€ 1~2ìª½ ë¶„ëŸ‰, ê¸€ì ìˆ˜ëŠ” 1,800~2,200ì ì‚¬ì´ ëª©í‘œ
- 2,200ìë¥¼ ë„˜ì§€ ì•Šë„ë¡ í•  ê²ƒ

# í˜„ì¬ì¼
- {TODAY_STR}
"""

if st.button("ğŸ“ 2ë‹¨ê³„: ì™„ì„±ëœ ê¸€ ìƒì„±", type="secondary"):
    if not st.session_state["analysis_result"]:
        st.error("ë¨¼ì € 1ë‹¨ê³„ íƒ€ë‹¹ì„± ë¶„ì„ì„ ì‹¤í–‰í•´ ì£¼ì„¸ìš”.")
    else:
        # ì´ë¯¸ ì œì¶œëœ í•™ë²ˆì¸ì§€ í™•ì¸
        if student_code in st.session_state["used_ids"]:
            st.error(
                f"í•™ë²ˆ ì½”ë“œ {student_code} ëŠ” ì´ë¯¸ ì œì¶œëœ ê¸°ë¡ì´ ìˆìŠµë‹ˆë‹¤.\n"
                "ë‹´ë‹¹ êµì‚¬ì—ê²Œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”."
            )
            st.stop()

        if not can_call_api():
            st.stop()

        try:
            api_key = get_api_key(user_api_key_input)
        except ValueError as e:
            st.error(str(e))
        else:
            with st.spinner("ì™„ì„±ëœ ë³´ê³ ì„œë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤..."):
                user_input_for_final = f"""
[í•™ìƒ ê¸°ë³¸ ì •ë³´]
í•™ë²ˆ ì½”ë“œ: {student_code}
ì´ë¦„: {student_name}
ë°˜: 2í•™ë…„ {class_no}ë°˜, ë²ˆí˜¸: {number}

[í•™ìƒ ì„ ì • ë™ê¸°]
{selected_motivation}

[ë¶„ì„ ëŒ€ìƒ ì§€ë¬¸]
{passage_text}

[AI íƒ€ë‹¹ì„± ë¶„ì„ ê²°ê³¼ ì „ì²´]
{st.session_state['analysis_result']}

[ì²´í¬ë°•ìŠ¤ë¡œ ì„ íƒëœ í¬í•¨ í•­ëª©]
- íƒ€ë‹¹ì„± ê²€ì‚¬ê°€ í•„ìš”í•œ ë¶€ë¶„ í¬í•¨: {st.session_state['include_needs_check']}
- ê²€ì‚¬Â·ê²€ì¦ ê²°ê³¼ í¬í•¨: {st.session_state['include_verification']}
- íƒ€ë‹¹ì„± í‰ê°€(ì ìˆ˜) í¬í•¨: {st.session_state['include_scores']}

[í•™ìƒì´ ìµœì¢… ê¸€ì— ë°˜ì˜í•˜ê³ ì ì„ íƒí•œ ì£¼ì¥/ë…¼ì ]
{st.session_state.get('selected_for_report', '')}

[4. í™œë™ ê²°ê³¼ ë©”ëª¨(í•™ìƒ í™œë™ ê²°ê³¼/ëŠë‚€ ì )]
{activity_notes}
"""
                try:
                    final_report = call_openai_text(
                        model=DEFAULT_MODEL,
                        instructions=FINAL_REPORT_INSTRUCTIONS,
                        user_input=user_input_for_final,
                        api_key=api_key,
                    )
                    # ì•„ì£¼ ê¸¸ê²Œ ë‚˜ì˜¬ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ì•ˆì „ì¥ì¹˜(ê°•ì œ ì»·, 2300ì ì„ ì—ì„œ ìë¥´ê¸°)
                    if len(final_report) > 2300:
                        final_report = final_report[:2300] + "\n\n(â€» ê¸€ì ìˆ˜ ì œí•œìœ¼ë¡œ ë‚´ìš© ì¼ë¶€ê°€ ìƒëµë˜ì—ˆìŠµë‹ˆë‹¤.)"

                    st.session_state["final_report"] = final_report
                    increase_api_count()

                    # í•™ë²ˆ ì‚¬ìš© ì²˜ë¦¬ (ì¤‘ë³µ ì œì¶œ ë°©ì§€)
                    st.session_state["used_ids"].add(student_code)
                    save_used_id(student_code)

                except RuntimeError as e:
                    st.error(str(e))


# ---------------- ì™„ì„± ê¸€ í‘œì‹œ ë° ë‹¤ìš´ë¡œë“œ ----------------
if st.session_state["final_report"]:
    st.success("2ë‹¨ê³„ ì™„ì„± ê¸€ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
    st.markdown("### ğŸ“„ ì™„ì„±ëœ ê¸€ (ë³´ê³ ì„œ ì´ˆì•ˆ)")
    st.markdown(st.session_state["final_report"])

    base_filename = "í•¨ì°½ê³ _ê¸€_íƒ€ë‹¹ì„±ê²€ì‚¬_í™œë™ë³´ê³ ì„œ"
    if student_code or student_name:
        base_filename += f"_{student_code}_{student_name}"
    filename = base_filename + ".txt"

    st.download_button(
        label="ğŸ’¾ ì™„ì„±ëœ ê¸€ ë‹¤ìš´ë¡œë“œ (.txt)",
        data=st.session_state["final_report"],
        file_name=filename,
        mime="text/plain",
    )
else:
    st.info("ì•„ì§ ì™„ì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì˜ [2ë‹¨ê³„: ì™„ì„±ëœ ê¸€ ìƒì„±] ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.")


# ---------------- í™”ë©´ ìš°ì¸¡ í•˜ë‹¨ 'ë§Œë“ ì´' í‘œì‹œ ----------------
st.markdown(
    """
    <div style="position: fixed; bottom: 10px; right: 10px; 
                font-size: 0.9rem; color: gray; background-color: rgba(255,255,255,0.7);
                padding: 4px 8px; border-radius: 4px;">
        ë§Œë“ ì´: í•¨ì°½ê³  êµì‚¬ ë°•í˜¸ì¢…
    </div>
    """,
    unsafe_allow_html=True,
)
