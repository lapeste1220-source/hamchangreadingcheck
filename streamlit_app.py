# -*- coding: utf-8 -*-
import os
import datetime
import streamlit as st
from openai import OpenAI

# ---------------- ê¸°ë³¸ ì„¤ì • ----------------
st.set_page_config(
    page_title="í•¨ì°½ê³  ê¸€ íƒ€ë‹¹ì„± ê²€ì‚¬",
    layout="wide"
)

st.title("í•¨ì°½ê³  ë°•í˜¸ì¢… ì„ ìƒë‹˜ê³¼ í•¨ê»˜í•˜ëŠ” ê¸€ì˜ íƒ€ë‹¹ì„± ê²€ì‚¬")
st.caption("ê³ 2 ë¹„íŒì  ë…í•´ ìˆ˜ì—…ìš© Â· ìƒì„±í˜• AIë¥¼ í™œìš©í•œ ì£¼ì¥â€“ê·¼ê±° íƒ€ë‹¹ì„± ì ê²€ ë„êµ¬")

TODAY_STR = datetime.date.today().isoformat()

# ê°€ì„±ë¹„ ëª¨ë¸ ê°•ì œ
DEFAULT_MODEL = "gpt-4o-mini"

# êµì‚¬ìš© ë¹„ë°€ë²ˆí˜¸ (ì„ ìƒë‹˜ì´ ì½”ë“œì—ì„œ ì–¸ì œë“  ë³€ê²½ ê°€ëŠ¥)
ADMIN_PASSWORD = "hamchang123"

# ì„¸ì…˜ë‹¹ ìµœëŒ€ API í˜¸ì¶œ íšŸìˆ˜
MAX_CALLS = 3


# ---------------- OpenAI ê´€ë ¨ í•¨ìˆ˜ ----------------
def get_api_key(user_input_key: str | None) -> str:
    """
    API í‚¤ ì„ íƒ ê·œì¹™
    1ìˆœìœ„: í•™ìƒì´ ì…ë ¥í•œ API í‚¤ (user_input_key)
    2ìˆœìœ„: êµì‚¬ìš© ë¹„ë°€ë²ˆí˜¸ë¥¼ ë§ì¶˜ ì„¸ì…˜ì¼ ë•Œ, ì„œë²„ì— ì €ì¥ëœ OPENAI_API_KEY
    ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ì—ëŸ¬ ë°œìƒ.
    """
    # 1) í•™ìƒ ê°œì¸ í‚¤ê°€ ìˆëŠ” ê²½ìš° â†’ ê·¸ í‚¤ ì‚¬ìš©
    if user_input_key and user_input_key.strip():
        return user_input_key.strip()

    # 2) í•™ìƒ í‚¤ëŠ” ì—†ì§€ë§Œ, êµì‚¬ìš© ë¹„ë°€ë²ˆí˜¸ë¥¼ ë§ì¶˜ ì„¸ì…˜ì¸ ê²½ìš° â†’ ì„ ìƒë‹˜ í‚¤ ì‚¬ìš©
    if st.session_state.get("is_admin", False):
        env_key = os.getenv("OPENAI_API_KEY")
        if not env_key:
            try:
                env_key = st.secrets.get("OPENAI_API_KEY", None)
            except Exception:
                env_key = None

        if env_key:
            return env_key
        else:
            raise ValueError(
                "êµì‚¬ìš© ë¹„ë°€ë²ˆí˜¸ëŠ” ë§ì•˜ì§€ë§Œ, ì„œë²„ì— OPENAI_API_KEY ì‹œí¬ë¦¿ì´ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
            )

    # 3) ë‘˜ ë‹¤ ì•„ë‹ˆë©´ â†’ ì‚¬ìš© ë¶ˆê°€
    raise ValueError(
        "OpenAI API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.\n"
        "- í•™ìƒ: ê°œì¸ OpenAI API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n"
        "- êµì‚¬: êµì‚¬ìš© ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ í•™êµ ê³µìš© í‚¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
    )


def call_openai_text(model: str, instructions: str, user_input: str, api_key: str) -> str:
    """
    OpenAI Chat Completions APIë¥¼ ì‚¬ìš©í•´ í…ìŠ¤íŠ¸ë¥¼ ë°˜í™˜.
    """
    client = OpenAI(api_key=api_key)

    try:
        resp = client.chat.completions.create(
            model=model,
            messages=[
                {"role": "system", "content": instructions},
                {"role": "user", "content": user_input},
            ],
        )
    except Exception as e:
        raise RuntimeError(f"OpenAI í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")

    try:
        return resp.choices[0].message.content.strip()
    except Exception:
        return str(resp)


def can_call_api() -> bool:
    """ë‚¨ì€ í˜¸ì¶œ ê°€ëŠ¥ íšŸìˆ˜ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³ , ì—†ìœ¼ë©´ ê²½ê³ ë¥¼ ë„ìš´ë‹¤."""
    used = st.session_state.get("usage_count", 0)
    if used >= MAX_CALLS:
        st.warning(f"ì´ ì„¸ì…˜ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ìµœëŒ€ í˜¸ì¶œ íšŸìˆ˜({MAX_CALLS}íšŒ)ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.")
        return False
    return True


def increase_api_count():
    """API í˜¸ì¶œ íšŸìˆ˜ 1íšŒ ì¦ê°€."""
    st.session_state["usage_count"] = st.session_state.get("usage_count", 0) + 1


# ---------------- íƒ€ë‹¹ì„± í‰ê°€ìš© ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ----------------
ANALYSIS_INSTRUCTIONS = f"""
ë‹¹ì‹ ì€ ê³ ë“±í•™êµ 2í•™ë…„ í•™ìƒì„ ë•ëŠ” 'ë¹„íŒì  ë…í•´Â·íƒ€ë‹¹ì„± í‰ê°€ ë„ìš°ë¯¸'ì…ë‹ˆë‹¤.
ì•„ë˜ ê·œì¹™ê³¼ ì¶œë ¥ í˜•ì‹ì„ ë°˜ë“œì‹œ ë”°ë¥´ì‹­ì‹œì˜¤.

# ëª©í‘œ Â· ì„±ê³¼ê¸°ì¤€
- ëª©í‘œ: í•™ìƒì´ ì œì‹œí•œ 'ì…ë ¥ ì§€ë¬¸'ì„ ëŒ€ìƒìœ¼ë¡œ ì£¼ì¥â€“ê·¼ê±°ì˜ íƒ€ë‹¹ì„±ì„ ì ê²€í•˜ê³ ,
  ì˜ì‹¬ìŠ¤ëŸ½ê±°ë‚˜ ë¯¸í¡í•œ ê·¼ê±°ë¥¼ ì‹ë³„í•´ ë¹„íŒì  ì½ê¸°ì˜ í•„ìš”ì„±ì„ ì²´ê°í•˜ë„ë¡ ë•ëŠ”ë‹¤.
- ì‚°ì¶œë¬¼ êµ¬ì„±:
  (1) ì£¼ì¥â€“ê·¼ê±° ë„ì‹í™”(í…ìŠ¤íŠ¸ íŠ¸ë¦¬/í‘œ),
  (2) ì£¼ì¥ë³„ íƒ€ë‹¹ë„ 5ì  ì²™ë„ í‰ê°€í‘œ,
  (3) ì ìˆ˜ëŒ€ë³„ ë¶„ë¥˜ ë° ê²€ì¦ ì‘ì—… ì„¤ê³„Â·ì¼ë¶€ ì‹¤í–‰ ìš”ì•½,
  (4) ê²€ì¦ìš© ë§í¬Â·ì¶œì²˜ ëª©ë¡,
  (5) ìµœì¢… í”¼ë“œë°±Â·ìê¸°ì ê²€ ì²´í¬ë¦¬ìŠ¤íŠ¸.
- ì„±ê³µê¸°ì¤€(ì²´í¬ë¦¬ìŠ¤íŠ¸)
  1) ëª¨ë“  í•µì‹¬ ì£¼ì¥ì— ëŒ€ì‘í•˜ëŠ” ê·¼ê±°ê°€ í‘œë¡œ ì •ë¦¬ë  ê²ƒ
  2) ê° ê·¼ê±°ì˜ ì¶œì²˜ ìœ í˜•/ì‹ ë¢°ë„/ê²€ì¦ ë‚œë„ ëª…ì‹œ
  3) 5ì  ì²™ë„ ê¸°ì¤€ì— ë”°ë¼ ì¼ê´€ëœ ì±„ì  ê·¼ê±° ì œì‹œ
  4) ì ìˆ˜ëŒ€ë³„ ê²€ì¦ ì‘ì—…(ì‚¬ì‹¤ í™•ì¸/ì¶”ê°€ ê·¼ê±°/ë°˜ì¦) ì œì‹œ ë° ì¼ë¶€ ì‹¤í–‰
  5) ì¸ìš©ì€ í•„ìš”í•œ ìµœì†Œ ë¶„ëŸ‰Â·ì •í™•í•œ ì¶œì „ í‘œê¸°, í‘œì ˆ/í™˜ê° ê²½ê³  í¬í•¨

# ë§¥ë½ Â· ì œì•½
- ë°°ê²½: ê³ 2 ë¹„íŒì  ë…í•´ ìˆ˜ì—…. í•™ìƒì´ ì§€ë¬¸ ì „ë¬¸ ë˜ëŠ” ì¶©ë¶„í•œ ë°œì·Œë¥¼ ì—…ë¡œë“œí•¨.
- ì œì•½:
  - ì €ì‘ê¶Œ ì¤€ìˆ˜(ì§ì ‘ ì¸ìš©ì€ 40~80ìÂ·í•„ìš” ìµœì†Œ),
  - ì¶œì²˜/ë§í¬ í•„ìˆ˜(ì›¹ ê²€ìƒ‰ ê°€ëŠ¥ ì‹œ ê³µì‹ ë ¥ ìˆëŠ” ìë£Œ ìš°ì„ : ì •ë¶€Â·ê³µì‹ í†µê³„Â·í•™ìˆ ì§€Â·ëŒ€í•™ ê°•ì˜ ë…¸íŠ¸Â·í‘œì¤€ êµê³¼ì„œ ë“±),
  - ì‹¤ì œ ì›¹ ë¸Œë¼ìš°ì§•ì€ í•˜ì§€ ë§ê³ , ê¸°ì–µì— ê¸°ë°˜í•œ ëŒ€í‘œì ì¸ ê¸°ê´€Â·êµì¬Â·ë…¼ë¬¸Â·ë„ì„œ ì¤‘ì‹¬ìœ¼ë¡œ ì¶”ì²œ.
  - URLì„ ì œì‹œí•  ë•ŒëŠ” ì‹¤ì œë¡œ ì¡´ì¬í•  ë²•í•œ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ë˜, í™•ì‹ ì´ ì—†ìœ¼ë©´ ê¸°ê´€ëª…Â·ìë£Œëª…Â·ì—°ë„Â·ê²€ìƒ‰ì–´ ìˆ˜ì¤€ìœ¼ë¡œ ì œì‹œí•˜ê³  ì„ì˜ì˜ ì£¼ì†Œë¥¼ ë§Œë“¤ì–´ë‚´ì§€ ë§ ê²ƒ.
- Do:
  - ì£¼ì¥â€“ê·¼ê±° ë§¤í•‘,
  - ê·¼ê±° ìœ í˜• êµ¬ë¶„(ë°ì´í„°/ì „ë¬¸ê°€ ê²¬í•´/ë…¼ë¦¬Â·ì‚¬ë¡€/ê¶Œìœ„ ì¸ìš© ë“±),
  - ë°˜ëŒ€ ê°€ëŠ¥ì„± íƒìƒ‰,
  - ì‰¬ìš´ ë§ ì„¤ëª….
- Donâ€™t:
  - ì§€ë¬¸ì„ ì„ì˜ë¡œ ë°”ê¾¸ê±°ë‚˜ í™•ëŒ€ í•´ì„í•˜ì§€ ë§ ê²ƒ,
  - ëª¨í˜¸í•œ ë‹¨ì •, ê·¼ê±° ì—†ëŠ” í‰ê°€ ê¸ˆì§€.

# ëŒ€ìƒ Â· í†¤
- ë…ì: ê³ ë“±í•™êµ 2í•™ë…„
- í†¤: ë˜ë ·í•˜ê³  ì¹œì ˆí•˜ê²Œ, ì‰¬ìš´ ì–´íœ˜ ìš°ì„ (ì „ë¬¸ ìš©ì–´ëŠ” ì§§ê²Œ í’€ì´)

# Plan First (ë°˜ë“œì‹œ ë¨¼ì € 5ì¤„ ê³„íš ì œì‹œ)
1) ì§€ë¬¸ ì£¼ì œÂ·í•µì‹¬ ì£¼ì¥ í›„ë³´
2) ê·¼ê±° ìœ í˜• ë¶„í¬ ì˜ˆìƒ
3) ì™¸ë¶€ ê²€ì¦ì´ í•„ìš”í•œ ìŸì  ëª©ë¡
4) ì‚¬ìš©í•  ë„ì‹í™” ë°©ì‹(íŠ¸ë¦¬/í‘œ/ë‹¤ì´ì–´ê·¸ë¨)ê³¼ ì´ìœ 
5) ë¸Œë¼ìš°ì§•(ì›¹ ê²€ìƒ‰) ê³„íšì´ ê°€ëŠ¥í•˜ë‹¤ê³  ê°€ì •í–ˆì„ ë•Œì˜ í‚¤ì›Œë“œ/ë°ì´í„°ë² ì´ìŠ¤, ë˜ëŠ” ëŒ€ì²´ ê²€ìƒ‰ì–´

â€» ì‹¤ì œ ì›¹ ê²€ìƒ‰ì€ í•˜ì§€ ë§ê³ , â€œì´ëŸ° ê±¸ ì°¾ìœ¼ë©´ ì¢‹ê² ë‹¤â€ ìˆ˜ì¤€ìœ¼ë¡œ ì‘ì„±.

# ë‹¨ê³„ë³„ ì§€ì¹¨(5~10ë‹¨ê³„)
1) ê·œì¹™ í™•ì¸: ì €ì‘ê¶Œ/ì¸ìš©, í‰ê°€ ì²™ë„ ì˜ë¯¸ë¥¼ ìŠ¤ìŠ¤ë¡œ ì¬í™•ì¸.
2) ì§€ë¬¸ ìš”ì•½(3ë¬¸ì¥ ì´ë‚´) â†’ í•µì‹¬ ì£¼ì¥ ëª©ë¡í™”(ë²ˆí˜¸ ë§¤ê¹€).
3) ì£¼ì¥ë³„ ê·¼ê±° ì¶”ì¶œÂ·ë¶„ë¥˜:
   - 40~80ì ì´ë‚´ë¡œ ì§§ê²Œ ì¸ìš©,
   - ë¬¸ë‹¨/ì¤„ ìœ„ì¹˜(ëŒ€ëµ) í‘œê¸°,
   - ê·¼ê±° ìœ í˜• í‘œê¸°(ë°ì´í„°/ì „ë¬¸ê°€ ê²¬í•´/ë…¼ë¦¬Â·ì‚¬ë¡€/ê¶Œìœ„ ì¸ìš© ë“±).
4) ë…¼ë¦¬ ì ê²€:
   - ì£¼ì¥â€“ì´ìœ â€“ê·¼ê±°â€“í•¨ì˜ ì—°ê²°,
   - ëˆ„ë½/ë¹„ì•½ í‘œì‹œ(ì˜ˆ: ì¥Â·ë‹¨ê¸° í˜¼ë™, ì •ì˜ ë¶ˆëª…í™•, ì¡°ê±´ ëˆ„ë½ ë“±).
5) 5ì  ì²™ë„ë¡œ ì±„ì , â€œì™œ ê·¸ ì ìˆ˜ì¸ì§€â€ 1~2ë¬¸ì¥ ê·¼ê±° ì„œìˆ .
6) ì ìˆ˜ëŒ€ë³„ ë¶„ë¥˜(5/4/3/2/1ì ) í›„ ê²€ì¦ ì‘ì—… ì„¤ê³„:
   - ì‚¬ì‹¤ ì—¬ë¶€ í™•ì¸, ì¶”ê°€ ê·¼ê±° ì¡°ì‚¬, ë°˜ì¦ ì‚¬ë¡€ ì°¾ê¸°(ê³¼ì œ í˜•íƒœ).
7) ê²€ì¦ ì¼ë¶€ ì‹¤í–‰:
   - ì£¼ì¥ë‹¹ 1~3ê°œ ì‹ ë¢° ê°€ëŠ¥í•œ ìë£Œê°€ ìˆë‹¤ê³  ê°€ì •í•˜ê³ ,
   - (1) ì‹¤ì œ ë˜ëŠ” ëŒ€í‘œì ì¸ ì›¹ì‚¬ì´íŠ¸ ì£¼ì†Œ í˜•ì‹, (2) ê´€ë ¨ ë„ì„œ, (3) ë…¼ë¬¸/í•™ìˆ ìë£Œë¥¼ ì˜ˆë¡œ ë“¤ì–´ ì œì‹œ.
   - ë‹¨, ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ” ê²ƒìœ¼ë¡œ ì˜ ì•Œë ¤ì§„ ê¸°ê´€Â·êµì¬Â·ë…¼ë¬¸ ìœ„ì£¼ë¡œ ì‘ì„±í•˜ê³ , ëª¨ë¥´ëŠ” ê²½ìš°ì—ëŠ” URL ëŒ€ì‹  ê¸°ê´€/ìë£Œëª…Â·ì—°ë„Â·ê²€ìƒ‰ì–´ë¥¼ ì œì•ˆí•  ê²ƒ.
8) êµ¬ì¡°í™” ì¶œë ¥:
   - ë„ì‹í™” â†’ í‰ê°€í‘œ â†’ ì ìˆ˜ëŒ€ë³„ ë¶„ë¥˜Â·ê²€ì¦ â†’ ë§í¬Â·ì¶œì²˜ â†’ í”¼ë“œë°±.
9) ë¦¬ìŠ¤í¬Â·ëŒ€ì•ˆ:
   - ë¶ˆí™•ì‹¤/ìŸì , ì¶”ê°€ í•„ìš” ë°ì´í„°, ìƒë°˜ëœ í•´ì„ ê°€ëŠ¥ì„± ì œì‹œ.
10) Self-Check í†µê³¼ í›„ ìµœì¢… ìš”ì•½(3ë¬¸ì¥).

# íƒ€ë‹¹ë„ 5ì  ì²™ë„(í‰ê°€ ê¸°ì¤€ ê³ ì •)
- 5ì : íƒ€ë‹¹ë„ê°€ ì•„ì£¼ ë†’ìŒ (ê·¼ê±°ê°€ ì¶©ë¶„Â·ì •í™•, ì‹ ë¢°ë„ ë†’ì€ ì¶œì²˜, ë°˜ë¡€ ê°€ëŠ¥ì„± ë‚®ìŒ)
- 4ì : íƒ€ë‹¹ë„ê°€ ë†’ìœ¼ë‚˜ ëª…í™•í•œ ì¶œì²˜ í™•ì¸ í•„ìš”
- 3ì : íƒ€ë‹¹ë„ê°€ ìˆìœ¼ë‚˜ ì¶œì²˜ê°€ ì—†ìŒ ë˜ëŠ” ì•½í•¨
- 2ì : íŠ¹ìˆ˜ ì‚¬ë¡€ì´ê±°ë‚˜ ì¼ë°˜í™”ê°€ ì–´ë ¤ìš´ ê·¼ê±°ì— ì˜ì¡´
- 1ì : ê·¼ê±°ê°€ ì—†ê±°ë‚˜ ì£¼ì¥ê³¼ ì§ì ‘ ì—°ê²°ë˜ì§€ ì•ŠìŒ

# ì¶œë ¥ í˜•ì‹(ë§ˆí¬ë‹¤ìš´, ë°˜ë“œì‹œ ì´ ìˆœì„œì™€ ì œëª© ì‚¬ìš©)
## 1) í•œëˆˆì— ë³´ëŠ” ìš”ì•½
- ì§€ë¬¸ ì£¼ì œ/í•µì‹¬ ì£¼ì¥(ìµœëŒ€ 3ê°œ)
- ì·¨ì•½ ê·¼ê±° Top 3ì™€ ì´ìœ (ê° 1ë¬¸ì¥)

## 2) ì£¼ì¥â€“ê·¼ê±° ë„ì‹í™”
- í…ìŠ¤íŠ¸ íŠ¸ë¦¬ í˜•ì‹
- ì´í›„ í‘œ í˜•ì‹

## 3) íƒ€ë‹¹ë„ í‰ê°€í‘œ(5ì  ì²™ë„)

## 4) ì ìˆ˜ëŒ€ë³„ ë¶„ë¥˜ ë° ê²€ì¦ì‘ì—…

## 5) ê²€ì¦ìš© ë§í¬Â·ì¶œì²˜
- ì‹¤ì œ ë˜ëŠ” ëŒ€í‘œì ì¸ ì›¹ì‚¬ì´íŠ¸(ê°€ëŠ¥í•œ ê²½ìš°), ê´€ë ¨ ë„ì„œ, ë…¼ë¬¸/í•™ìˆ ìë£Œë¥¼ í•¨ê»˜ ì œì‹œ
- í™•ì‹ ì´ ì—†ëŠ” ê²½ìš°ì—ëŠ” URL ëŒ€ì‹  ê¸°ê´€ëª…Â·ìë£Œëª…Â·ì—°ë„Â·ê²€ìƒ‰ì–´ ì¶”ì²œ

## 6) ìµœì¢… í”¼ë“œë°±
- ê¸€ì˜ ë…¼ì¦ ê°•Â·ì•½ì  ìš”ì•½(3~5ë¬¸ì¥)
- ì¶”ê°€ ì½ê¸° ì œì•ˆ
- ìˆ˜ì—… í† ë¡  ì§ˆë¬¸ 3ê°œ

## 7) Self-Check

# ì‹œê°„ ê°ê°
- í˜„ì¬ì¼: {TODAY_STR}.
- ìµœì‹ ì„± í•„ìš”í•œ í•­ëª©ì€ ìµœê·¼ 3~5ë…„ ìë£Œë¥¼ ë¨¼ì € ê³ ë ¤í•˜ë¼ê³  ê¶Œì¥í•˜ë˜, ì‹¤ì œ ê²€ìƒ‰ì€ í•˜ì§€ ë§ê³  ì¶”ì²œ í˜•ì‹ìœ¼ë¡œë§Œ ì œì‹œí•  ê²ƒ.

# ì¤‘ìš”
- ê²°ê³¼ëŠ” ê³ 2 í•™ìƒì´ ê·¸ëŒ€ë¡œ ì½ê³  ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡, ë„ˆë¬´ ì–´ë ¤ìš´ ìˆ˜ì‹Â·ì „ë¬¸ ìš©ì–´ëŠ” í”¼í•˜ê³ , ë‚˜ì˜¬ ê²½ìš° ì§§ê²Œ í’€ì´ë¥¼ í•¨ê»˜ ì œì‹œ.
"""


# ---------------- ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” ----------------
if "analysis_result" not in st.session_state:
    st.session_state["analysis_result"] = ""

if "final_report" not in st.session_state:
    st.session_state["final_report"] = ""

if "usage_count" not in st.session_state:
    st.session_state["usage_count"] = 0

if "is_admin" not in st.session_state:
    st.session_state["is_admin"] = False

if "selected_for_report" not in st.session_state:
    st.session_state["selected_for_report"] = ""


# ---------------- ì‚¬ì´ë“œë°”: ì‚¬ìš© ì•ˆë‚´ + êµì‚¬ìš© ì„¤ì • ----------------
with st.sidebar:
    st.header("ì‚¬ìš© ì•ˆë‚´")
    st.markdown(
        """
í•™ìƒì€ ì•„ë˜ ìˆœì„œëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤:

1. **í•™ë²ˆê³¼ ì´ë¦„**ì„ ì…ë ¥í•©ë‹ˆë‹¤.
2. **ì„ ì • ë™ê¸°**ë¥¼ ê°„ë‹¨íˆ ì ìŠµë‹ˆë‹¤.
3. **ë¶„ì„í•  ê¸€(ì§€ë¬¸)**ì„ ë¶™ì—¬ë„£ìŠµë‹ˆë‹¤.
4. **íƒ€ë‹¹ì„± ì¡°ì‚¬ í¬ì¸íŠ¸**(ë³´ê³  ì‹¶ì€ ë¶€ë¶„)ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.
5. (ì„ íƒ) ìì‹ ì˜ **OpenAI API í‚¤**ë¥¼ ì…ë ¥í•˜ê±°ë‚˜,  
   êµì‚¬ìš© ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ í•™êµ ê³µìš© í‚¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
6. **[1ë‹¨ê³„: íƒ€ë‹¹ì„± ë¶„ì„ ì‹¤í–‰]** ë²„íŠ¼ì„ ëˆ„ë¦…ë‹ˆë‹¤.
7. ê²°ê³¼ë¥¼ ì½ê³ , **ì™„ì„±ëœ ê¸€ì— ë°˜ì˜í•  ì£¼ì¥Â·ë…¼ì **ì„ ì •ë¦¬í•´ ì²´í¬(ì„ íƒ)í•©ë‹ˆë‹¤.
8. í™œë™ ê²°ê³¼/ëŠë‚€ ì ì„ ì ê³  **[2ë‹¨ê³„: ì™„ì„±ëœ ê¸€ ìƒì„±]** ë²„íŠ¼ì„ ëˆ„ë¦…ë‹ˆë‹¤.
9. ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ **í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ** í›„ ì¶œë ¥í•©ë‹ˆë‹¤.
        """
    )

    st.markdown("---")
    st.markdown("**í˜„ì¬ ì„¸ì…˜ ì‚¬ìš©ëŸ‰**")
    st.write(f"API í˜¸ì¶œ ì‚¬ìš© íšŸìˆ˜: {st.session_state['usage_count']} / {MAX_CALLS}")

    st.markdown("---")
    st.subheader("êµì‚¬ìš© ì„¤ì •")

    admin_pw = st.text_input(
        "êµì‚¬ìš© ë¹„ë°€ë²ˆí˜¸ (ì…ë ¥ ì‹œ í•™êµ ê³µìš© í‚¤ ì‚¬ìš© ê°€ëŠ¥)",
        type="password"
    )

    if admin_pw == ADMIN_PASSWORD:
        st.session_state["is_admin"] = True
        st.caption("âœ… êµì‚¬ìš© ë¹„ë°€ë²ˆí˜¸ê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ì„¸ì…˜ì—ì„œëŠ” í•™êµ ê³µìš© API í‚¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
    elif admin_pw:
        st.session_state["is_admin"] = False
        st.caption("âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (í•™ìƒì€ ê°œì¸ API í‚¤ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.)")

    st.markdown("---")
    st.markdown("**API í‚¤ ì•ˆë‚´**")
    st.caption(
        "í•™ìƒ: ê°œì¸ OpenAI API í‚¤ê°€ ìˆìœ¼ë©´ ì…ë ¥ë€ì— ë„£ì–´ ì‚¬ìš©í•˜ì„¸ìš”.\n"
        "êµì‚¬: êµì‚¬ìš© ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë©´ ì„œë²„ì— ì €ì¥ëœ í•™êµ ê³µìš© í‚¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
    )


# ---------------- ë©”ì¸ ì…ë ¥ ì˜ì—­ ----------------
col_left, col_right = st.columns([2, 1])

with col_left:
    st.subheader("1. ê¸°ë³¸ ì •ë³´ ë° í•™ìƒ ì…ë ¥ ì˜ì—­")

    student_id = st.text_input("í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”.", placeholder="ì˜ˆ) 20403")
    student_name = st.text_input("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.", placeholder="ì˜ˆ) í™ê¸¸ë™")

    selected_motivation = st.text_area(
        "â‘  ì´ ê¸€(ë˜ëŠ” ì±…/ìë£Œ)ì„ ì„ íƒí•œ ì´ìœ (ì„ ì • ë™ê¸°)ë¥¼ ì ì–´ ë³´ì„¸ìš”.",
        height=80,
        placeholder="ì˜ˆ) ê²½ì œì—ì„œ 'í•©ë¦¬ì  ì„ íƒ'ì´ ì‹¤ì œ ê¸°ì—… í–‰ë™ê³¼ ì—°ê²°ë˜ëŠ” ë°©ì‹ì´ ê¶ê¸ˆí•´ì„œ ì„ íƒí–ˆë‹¤."
    )

    passage_text = st.text_area(
        "â‘¡ íƒ€ë‹¹ì„±ì„ í‰ê°€í•˜ê³  ì‹¶ì€ ê¸€(ì§€ë¬¸)ì„ ë¶™ì—¬ ë„£ìœ¼ì„¸ìš”.",
        value="",  # ì˜ˆì‹œê¸€ì€ ë³´ì´ì§€ ì•Šë„ë¡ ì‚­ì œ
        height=260,
        placeholder="ë¶„ì„í•˜ê³  ì‹¶ì€ ê¸€(ì§€ë¬¸)ì„ ì—¬ê¸°ì— ë¶™ì—¬ ë„£ìœ¼ì„¸ìš”."
    )

    st.markdown("**â‘¢ íŠ¹íˆ ì–´ë–¤ ì ì˜ íƒ€ë‹¹ì„±ì„ ì ê²€í•´ ë³´ê³  ì‹¶ë‚˜ìš”? (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)**")

    # ìš”ì²­í•˜ì‹  'ì¼ë°˜ì ì¸ íƒ€ë‹¹ì„± ê²€ì‚¬ í¬ì¸íŠ¸'
    validity_options = [
        "ì£¼ì¥ì— ë§ëŠ” ê·¼ê±°ê°€ ì œì‹œë˜ì–´ ìˆëŠ”ê°€?",
        "ê·¼ê±°ì˜ ì–‘ì´ ì¶©ë¶„í•œê°€?",
        "ê·¼ê±°ì˜ ì§ˆì´ ì¶©ë¶„í•œê°€?",
        "ê·¼ê±°ì˜ ì¶œì²˜ê°€ ëª…í™•í•œê°€?",
        "ê·¼ê±°ì˜ ì¶œì²˜ê°€ ì œì‹œëœ ì´í›„ ë°˜ë¡ ì´ë‚˜ ë°˜ë°• ì‚¬ë¡€ê°€ ì—†ëŠ”ê°€?",
        "í•´ë‹¹ ê·¼ê±°ê°€ ì‚¬ì‹¤ìƒ ìœ ì¼í•œ ê·¼ê±°ë¡œì„œì˜ í˜ì´ ìˆëŠ”ê°€?",
        "ê¸°íƒ€(í•™ìƒì´ ë”°ë¡œ ì ì„ ë¶€ë¶„)"
    ]
    selected_points = st.multiselect(
        "íƒ€ë‹¹ì„± ì¡°ì‚¬ í¬ì¸íŠ¸ ì„ íƒ",
        options=validity_options,
        default=[
            "ì£¼ì¥ì— ë§ëŠ” ê·¼ê±°ê°€ ì œì‹œë˜ì–´ ìˆëŠ”ê°€?",
            "ê·¼ê±°ì˜ ì¶œì²˜ê°€ ëª…í™•í•œê°€?",
        ]
    )

    extra_point = st.text_input(
        "â‘£ ìœ„ì— ì—†ëŠ” ë‹¤ë¥¸ ì¡°ì‚¬ í¬ì¸íŠ¸ê°€ ìˆë‹¤ë©´ ì ì–´ ì£¼ì„¸ìš” (ì„ íƒ).",
        placeholder="ì˜ˆ) êµê³¼ì„œì—ì„œ ë°°ìš´ ë‚´ìš©ê³¼ ë‹¤ë¥¸ ë¶€ë¶„ì´ ìˆëŠ”ì§€ ë“±"
    )

with col_right:
    st.subheader("2. OpenAI API ì„¤ì •")
    user_api_key_input = st.text_input(
        "OpenAI API í‚¤ (ì„ íƒ, ì—†ìœ¼ë©´ êµì‚¬ìš© ë¹„ë°€ë²ˆí˜¸ë¡œ ê³µìš© í‚¤ ì‚¬ìš©)",
        type="password",
        help="í•™ìƒ: ê°œì¸ í‚¤ ì…ë ¥ / êµì‚¬: ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í›„ ê³µìš© í‚¤ ì‚¬ìš©"
    )

    st.markdown("---")
    st.subheader("3. í™œë™ ê²°ê³¼ ë©”ëª¨ (2ë‹¨ê³„ì—ì„œ í™œìš©)")
    activity_notes = st.text_area(
        "íƒ€ë‹¹ì„± ë¶„ì„ ê²°ê³¼ë¥¼ ì½ê³ , ìŠ¤ìŠ¤ë¡œ ì •ë¦¬í•œ í™œë™ ê²°ê³¼Â·ëŠë‚€ ì ì„ ê°„ë‹¨íˆ ì ì–´ ë³´ì„¸ìš”.",
        height=160,
        placeholder="ì˜ˆ) A ì£¼ì¥ì— ë¹„í•´ B ì£¼ì¥ì€ ê·¼ê±°ê°€ ì•½í•˜ë‹¤ëŠ” ëŠë‚Œì„ ë°›ì•˜ê³ , ì•ìœ¼ë¡œ ê²½ì œ ê¸°ì‚¬ë¥¼ ì½ì„ ë•Œë„ ê·¼ê±°ì˜ ì¶œì²˜ë¥¼ ë” ê¼¼ê¼¼íˆ ë³´ì•„ì•¼ê² ë‹¤ê³  ìƒê°í–ˆë‹¤."
    )


# ---------------- 1ë‹¨ê³„: íƒ€ë‹¹ì„± ë¶„ì„ ì‹¤í–‰ ----------------
st.markdown("---")
st.subheader("4. 1ë‹¨ê³„: ìƒì„±í˜• AIë¥¼ í™œìš©í•œ íƒ€ë‹¹ì„± ë¶„ì„")

if st.button("ğŸ§ª 1ë‹¨ê³„: íƒ€ë‹¹ì„± ë¶„ì„ ì‹¤í–‰", type="primary"):
    if not passage_text.strip():
        st.error("ì§€ë¬¸(ë¶„ì„í•  ê¸€)ì„ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”.")
    else:
        if not can_call_api():
            st.stop()

        try:
            api_key = get_api_key(user_api_key_input)
        except ValueError as e:
            st.error(str(e))
        else:
            with st.spinner("íƒ€ë‹¹ì„± ë¶„ì„ì„ ìˆ˜í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”..."):
                points_text = ", ".join(selected_points) if selected_points else "í•™ìƒì´ ë³„ë„ í¬ì¸íŠ¸ë¥¼ ì„ íƒí•˜ì§€ ì•ŠìŒ"
                if extra_point.strip():
                    points_text += f"; ì¶”ê°€ í¬ì¸íŠ¸: {extra_point.strip()}"

                user_input_for_analysis = f"""
[í•™ìƒ ê¸°ë³¸ ì •ë³´]
í•™ë²ˆ: {student_id}
ì´ë¦„: {student_name}

[í•™ìƒ ì„ ì • ë™ê¸°]
{selected_motivation}

[í•™ìƒì´ íŠ¹íˆ ì ê²€í•˜ê³  ì‹¶ì€ íƒ€ë‹¹ì„± í¬ì¸íŠ¸]
{points_text}

[ë¶„ì„ ëŒ€ìƒ ì§€ë¬¸]
{passage_text}
"""

                try:
                    analysis_result = call_openai_text(
                        model=DEFAULT_MODEL,
                        instructions=ANALYSIS_INSTRUCTIONS,
                        user_input=user_input_for_analysis,
                        api_key=api_key,
                    )
                    st.session_state["analysis_result"] = analysis_result
                    increase_api_count()
                except RuntimeError as e:
                    st.error(str(e))


# ---------------- ë¶„ì„ ê²°ê³¼ í‘œì‹œ + ìµœì¢… ê¸€ì— ë°˜ì˜í•  ì£¼ì¥/ë…¼ì  ì„ íƒ ----------------
if st.session_state["analysis_result"]:
    st.success("1ë‹¨ê³„ íƒ€ë‹¹ì„± ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
    st.markdown("### ğŸ” AI ê¸°ë°˜ íƒ€ë‹¹ì„± ë¶„ì„ ê²°ê³¼")
    st.markdown(st.session_state["analysis_result"])

    st.markdown("---")
    st.subheader("5. ì™„ì„±ëœ ê¸€ì— ë°˜ì˜í•  ì£¼ì¥Â·ë…¼ì  ì„ íƒ")

    selected_for_report = st.text_area(
        "íƒ€ë‹¹ì„± ë¶„ì„ ê²°ê³¼ë¥¼ ì½ê³ , **ì™„ì„±ëœ ê¸€ì— ê¼­ ë°˜ì˜í•˜ê³  ì‹¶ì€ ì£¼ì¥Â·ë…¼ì ë§Œ** bullet í˜•ì‹ìœ¼ë¡œ ì •ë¦¬í•´ ë³´ì„¸ìš”.\n"
        "â€» ì—¬ê¸°ì— ì ì€ ë‚´ìš©ë§Œ ì¤‘ì‹¬ìœ¼ë¡œ ìµœì¢… ê¸€ì´ ì‘ì„±ë©ë‹ˆë‹¤.",
        height=180,
        placeholder="ì˜ˆ)\n- í•œê³„ë¹„ìš©ê³¼ í•œê³„ìˆ˜ì…ì´ ì¼ì¹˜í•  ë•Œ ì´ìœ¤ì´ ê·¹ëŒ€í™”ëœë‹¤ëŠ” ì£¼ì¥ì€ ê·¼ê±°ê°€ ë¹„êµì  íƒ„íƒ„í–ˆë‹¤.\n- í‰ê· ë¹„ìš©ê³¼ ì†ì‹¤ íŒë‹¨ ë¶€ë¶„ì€ ë‹¨ê¸°/ì¥ê¸° êµ¬ë¶„ì´ ë¶ˆë¶„ëª…í•´ ì¶”ê°€ ê²€ì¦ì´ í•„ìš”í•˜ë‹¤.",
        value=st.session_state.get("selected_for_report", "")
    )
    st.session_state["selected_for_report"] = selected_for_report

else:
    st.info("ì•„ì§ 1ë‹¨ê³„ ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ ë²„íŠ¼ìœ¼ë¡œ ë¨¼ì € íƒ€ë‹¹ì„± ë¶„ì„ì„ ì‹¤í–‰í•´ ì£¼ì„¸ìš”.")


# ---------------- 2ë‹¨ê³„: ì™„ì„±ëœ ê¸€(ë³´ê³ ì„œ) ìƒì„± ----------------
st.markdown("---")
st.subheader("6. 2ë‹¨ê³„: í•™ìƒ í™œë™ê¹Œì§€ ë°˜ì˜í•œ ì™„ì„± ê¸€ ìƒì„±")

FINAL_REPORT_INSTRUCTIONS = f"""
ë‹¹ì‹ ì€ 'ë¹„íŒì  ë…í•´ í™œë™ ë³´ê³ ì„œ'ë¥¼ ì‘ì„±í•˜ëŠ” ì¡°êµì…ë‹ˆë‹¤.
ì•„ë˜ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ê³ ë“±í•™êµ 2í•™ë…„ í•™ìƒì˜ í™œë™ ê²°ê³¼ë¥¼ ì •ë¦¬í•œ ê¸€ì„ ì¨ ì£¼ì„¸ìš”.

# ì—­í• 
- ê³ 2 í•™ìƒì´ ì œì¶œí•  ìˆ˜ ìˆëŠ” 'ë¹„íŒì  ë…í•´Â·íƒ€ë‹¹ì„± ê²€ì‚¬ í™œë™ ë³´ê³ ì„œ' ì´ˆì•ˆì„ ì‘ì„±í•©ë‹ˆë‹¤.
- êµì‚¬ê°€ ìš”êµ¬í•œ í˜•ì‹ì— ë§ì¶”ë˜, í•™ìƒì˜ ëª©ì†Œë¦¬ê°€ ëŠê»´ì§€ë„ë¡ 1ì¸ì¹­(ì €ëŠ”/ë‚˜ëŠ”) ì‹œì ë„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ë„ ì¢‹ìŠµë‹ˆë‹¤.

# ë§¤ìš° ì¤‘ìš”í•œ ì œí•œ
- ì „ì²´ ë¶„ëŸ‰ì€ **í•œêµ­ì–´ ê¸°ì¤€ ê³µë°± í¬í•¨ ì•½ 1,800~2,200ì(2000ì ë‚´ì™¸)**ë¡œ í•˜ì‹­ì‹œì˜¤.
- 2,200ìë¥¼ ë„˜ê¸°ì§€ ë§ˆì‹­ì‹œì˜¤.
- ì•„ë˜ì— ì œê³µë˜ëŠ” ì •ë³´ ì¤‘, íŠ¹íˆ
  - [í•™ìƒì´ ìµœì¢… ê¸€ì— ë°˜ì˜í•˜ê³ ì ì„ íƒí•œ ì£¼ì¥/ë…¼ì ]
  - [í•™ìƒ í™œë™ ê²°ê³¼/ëŠë‚€ ì ]
  ì´ ë‘ ë¶€ë¶„ì„ ì¤‘ì‹¬ìœ¼ë¡œ ê¸€ì„ êµ¬ì„±í•˜ê³ , ë‚˜ë¨¸ì§€ í‰ê°€ëŠ” ê°„ë‹¨í•œ ë³´ì¡° ì„¤ëª…ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.

# êµ¬ì„±
1) í™œë™ ë°°ê²½Â·ì„ ì • ë™ê¸° (1~2ë¬¸ë‹¨)
2) ì§€ë¬¸ í•µì‹¬ ë‚´ìš©ê³¼ í•™ìƒì´ ì„ íƒí•œ ì£¼ìš” ì£¼ì¥ ì •ë¦¬ (1ë¬¸ë‹¨)
3) **í•™ìƒì´ ì„ íƒí•œ ì£¼ì¥/ë…¼ì ì— ëŒ€í•œ íƒ€ë‹¹ì„± ë¶„ì„ ê³¼ì • ìš”ì•½**
   - ì–´ë–¤ ì£¼ì¥ì— ê·¼ê±°ê°€ íŠ¼íŠ¼í–ˆëŠ”ì§€
   - ì–´ë–¤ ì£¼ì¥ì— ê·¼ê±°ê°€ ì•½í–ˆëŠ”ì§€
   - ë…¼ë¦¬ì  ë¹„ì•½Â·ëª¨í˜¸í•œ í‘œí˜„ ì˜ˆì‹œ
4) ì™¸ë¶€ ê²€ì¦(ì¶œì²˜Â·ìë£Œ ì¡°ì‚¬) ê³„íš ë˜ëŠ” ì˜ˆì‹œ 1~2ê°œ
5) í™œë™ì„ í†µí•´ ë°°ìš´ ì Â·ì•ìœ¼ë¡œì˜ ë‹¤ì§ (1~2ë¬¸ë‹¨)

# í†¤
- ë˜ë ·í•˜ê³  ì§„ì§€í•˜ì§€ë§Œ, ê³ 2 í•™ìƒì˜ ìì—°ìŠ¤ëŸ¬ìš´ ê¸€ ëŠë‚Œ ìœ ì§€
- ë„ˆë¬´ ê³¼ì¥ëœ ë¬¸ì¥ë³´ë‹¤ëŠ” ì‹¤ì œ ìˆ˜ì—… í™œë™ì²˜ëŸ¼ ë‹´ë°±í•˜ê²Œ

# ê¸¸ì´
- ëŒ€ëµ A4 ê¸°ì¤€ 1~2ìª½ ë¶„ëŸ‰ì— í•´ë‹¹í•˜ë˜, ê¸€ì ìˆ˜ëŠ” 1,800~2,200ì ì‚¬ì´ë¥¼ ëª©í‘œë¡œ í•©ë‹ˆë‹¤.
- 2,200ìë¥¼ ë„˜ê¸°ì§€ ë§ˆì‹­ì‹œì˜¤.

# í˜„ì¬ì¼
- {TODAY_STR}
"""

if st.button("ğŸ“ 2ë‹¨ê³„: ì™„ì„±ëœ ê¸€ ìƒì„±", type="secondary"):
    if not st.session_state["analysis_result"]:
        st.error("ë¨¼ì € 1ë‹¨ê³„ íƒ€ë‹¹ì„± ë¶„ì„ì„ ì‹¤í–‰í•´ ì£¼ì„¸ìš”.")
    else:
        if not can_call_api():
            st.stop()

        try:
            api_key = get_api_key(user_api_key_input)
        except ValueError as e:
            st.error(str(e))
        else:
            with st.spinner("ì™„ì„±ëœ ë³´ê³ ì„œë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤..."):
                user_input_for_final = f"""
[í•™ìƒ ê¸°ë³¸ ì •ë³´]
í•™ë²ˆ: {student_id}
ì´ë¦„: {student_name}

[í•™ìƒ ì„ ì • ë™ê¸°]
{selected_motivation}

[ë¶„ì„ ëŒ€ìƒ ì§€ë¬¸]
{passage_text}

[AI íƒ€ë‹¹ì„± ë¶„ì„ ê²°ê³¼ ìš”ì•½]
{st.session_state['analysis_result']}

[í•™ìƒì´ ìµœì¢… ê¸€ì— ë°˜ì˜í•˜ê³ ì ì„ íƒí•œ ì£¼ì¥/ë…¼ì ]
{st.session_state.get('selected_for_report', '')}

[í•™ìƒ í™œë™ ê²°ê³¼/ëŠë‚€ ì ]
{activity_notes}
"""
                try:
                    final_report = call_openai_text(
                        model=DEFAULT_MODEL,
                        instructions=FINAL_REPORT_INSTRUCTIONS,
                        user_input=user_input_for_final,
                        api_key=api_key,
                    )
                    # ì•„ì£¼ ê¸¸ê²Œ ë‚˜ì˜¬ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ì•ˆì „ì¥ì¹˜(ê°•ì œ ì»·, 2300ì ì„ ì—ì„œ ìë¥´ê¸°)
                    if len(final_report) > 2300:
                        final_report = final_report[:2300] + "\n\n(â€» ê¸€ì ìˆ˜ ì œí•œìœ¼ë¡œ ë‚´ìš© ì¼ë¶€ê°€ ìƒëµë˜ì—ˆìŠµë‹ˆë‹¤.)"

                    st.session_state["final_report"] = final_report
                    increase_api_count()
                except RuntimeError as e:
                    st.error(str(e))


# ---------------- ì™„ì„± ê¸€ í‘œì‹œ ë° ë‹¤ìš´ë¡œë“œ ----------------
if st.session_state["final_report"]:
    st.success("2ë‹¨ê³„ ì™„ì„± ê¸€ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
    st.markdown("### ğŸ“„ ì™„ì„±ëœ ê¸€ (ë³´ê³ ì„œ ì´ˆì•ˆ)")
    st.markdown(st.session_state["final_report"])

    # íŒŒì¼ ì´ë¦„ì— í•™ë²ˆÂ·ì´ë¦„ ë°˜ì˜ (ìˆìœ¼ë©´)
    base_filename = "í•¨ì°½ê³ _ê¸€_íƒ€ë‹¹ì„±ê²€ì‚¬_í™œë™ë³´ê³ ì„œ"
    if student_id or student_name:
        base_filename += f"_{student_id}_{student_name}"
    filename = base_filename + ".txt"

    st.download_button(
        label="ğŸ’¾ ì™„ì„±ëœ ê¸€ ë‹¤ìš´ë¡œë“œ (.txt)",
        data=st.session_state["final_report"],
        file_name=filename,
        mime="text/plain",
    )
else:
    st.info("ì•„ì§ ì™„ì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì˜ [2ë‹¨ê³„: ì™„ì„±ëœ ê¸€ ìƒì„±] ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.")


# ---------------- í™”ë©´ ìš°ì¸¡ í•˜ë‹¨ 'ë§Œë“ ì´' í‘œì‹œ ----------------
st.markdown(
    """
    <div style="position: fixed; bottom: 10px; right: 10px; 
                font-size: 0.9rem; color: gray; background-color: rgba(255,255,255,0.7);
                padding: 4px 8px; border-radius: 4px;">
        ë§Œë“ ì´: í•¨ì°½ê³  êµì‚¬ ë°•í˜¸ì¢…
    </div>
    """,
    unsafe_allow_html=True,
)
